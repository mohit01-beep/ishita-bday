<script>
/* START */
function startSite(){
  createClouds(5);
  observeSections();

  // ‚ù§Ô∏è FIXED: Start music on button click (bypasses browser autoplay block)
  const music = document.getElementById("bg-music");
  music.volume = 0.4;
  music.play().catch(err => console.log("Autoplay blocked, will retry:", err));
}

/* Fade-in bubbles */
function observeSections(){
  const obs=new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        entry.target.querySelectorAll('.text-bubble')
          .forEach((b,i)=>setTimeout(()=>b.classList.add('fade-in'), i*300));
      }
    });
  },{threshold:0.25});
  document.querySelectorAll('.section').forEach(s=>obs.observe(s));
}

/* Final message */
function revealMessage(choice){
  if(choice){
    document.getElementById('interactive').style.display='none';
    document.getElementById('final-message').style.display='flex';
    document.getElementById('final-message').scrollIntoView({behavior:'smooth'});
  }
}

/* Heart trail */
document.addEventListener('click',e=>createTrail(e.clientX,e.clientY));
document.addEventListener('touchmove',e=>{
  for(const t of e.touches) createTrail(t.clientX,t.clientY);
});
function createTrail(x,y){
  const h=document.createElement('div');
  h.className='heart small';
  h.style.left=x+'px';
  h.style.top=y+'px';
  document.body.appendChild(h);
  setTimeout(()=>h.remove(),1700);
}

/* Clouds */
function createClouds(count){
  for(let i=0;i<count;i++){
    const c=document.createElement('div');
    c.className='cloud';
    const sz=120+Math.random()*150;
    c.style.width=sz+'px';
    c.style.height=sz/2+'px';
    c.style.left=Math.random()*100+'vw';
    c.style.top=Math.random()*50+'vh';
    document.body.appendChild(c);
    moveCloud(c,0.02+Math.random()*0.03);
  }
}
function moveCloud(cloud,speed){
  let pos=parseFloat(cloud.style.left);
  function step(){
    pos+=speed;
    if(pos>110) pos=-20;
    cloud.style.left=pos+'vw';
    requestAnimationFrame(step);
  }
  step();
}

/* ‚≠ê UPDATED: Stars should appear ONLY after night */
let starsCreated = false;

function createStars(count){
  for(let i=0;i<count;i++){
    const s=document.createElement('div');
    s.className='star';
    s.style.left=Math.random()*100+'vw';
    s.style.top=Math.random()*100+'vh';
    document.body.appendChild(s);
  }
  starsCreated = true;
}

function removeStars(){
  document.querySelectorAll('.star').forEach(s => s.remove());
  starsCreated = false;
}

/* üå† Shooting Stars */
function createShootingStar() {
  if (!starsCreated) return; // shooting star only at night

  const star = document.createElement('div');
  star.className = 'shooting-star';

  star.style.top = (Math.random()*50)+'vh';
  star.style.left = (Math.random()*80+10)+'vw';

  document.body.appendChild(star);

  setTimeout(()=>{
    star.style.transition="all 1.2s ease-out";
    star.style.transform="translate(-200px,200px) rotate(-45deg)";
    star.style.opacity=1;
  },50);

  setTimeout(()=>star.remove(),1400);
}

setInterval(()=>{
  if(Math.random()>0.6) createShootingStar();
},2000);

/* üåô Moon + ‚≠ê Stars visibility triggered by scroll */
window.addEventListener('scroll',()=>{
  let max=document.body.scrollHeight-window.innerHeight;
  let p=window.scrollY/max;

  const moon=document.getElementById("moon");

  if(p>0.55){
    moon.style.opacity=1;

    if(!starsCreated) createStars(120);
    document.querySelectorAll('.star').forEach(s=>s.style.opacity=1);

  } else {
    moon.style.opacity=0;
    removeStars();
  }
});
</script>